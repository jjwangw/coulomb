#!/usr/bin/env bash
#coded on Jan.4,2023 by jjwang
usage(){
echo -e "\033[1msplit_sampling_profile.sh\033[0m is used to split a file with sampling points of a profile and projected coordinates of aftershocks (if there are some ones) into two files. One has sampling points of the profile, the other has the mapped aftershocks."
echo ""
echo "Usage: split_sampling_profile.sh <filename>"
echo "filename: the file generated by the subroutine preprocsampling_profile"
echo ""
exit 1
}

if [ $# -ne 1 ];then
  usage
fi
filename=$1
dir_name=$(dirname "$filename")
base_name=$(basename "$filename")
file=${base_name%%.*}
extension=${base_name##*.}
#echo "dir_name=$dir_name base_name=$base_name file=$file extension=$extension"
str="#     lat(deg)      lon(deg)       depth(km)       ksi(km)      W-eta(km)(downdip)"
nL=$(grep "nL" $filename | sed 's/[#a-zA-Z=:]//g' | awk '{print $1}')
nW=$(grep "nW" $filename | sed 's/[#a-zA-Z=:]//g' | awk '{print $2}')
#echo "nL=$nL nW=$nW"
nline=$(grep -n "$str" $filename | cut -f1 -d":" | sed -n 'H;${x;s/\n/ /g;p;}')
#echo "nline=$nline"
nline1=$(echo $nline | awk '{print $1+2}')
nline2=$(echo $nline | awk '{print $2-2}')
nline3=$(echo $nline | awk '{print $2}')
#echo "nline1=$nline1 nline2=$nline2 nline3=$nline3"
outputfile1="${dir_name}/${file}_profile.${extension}"
outputfile2="${dir_name}/${file}_aftershocks.${extension}"
outputfile3="${dir_name}/${file}_profile_grids.${extension}"
#outputfile1="${file}_profile.${extension}"
#outputfile2="${file}_aftershocks.${extension}"
#outputfile3="${file}_profile_grids.${extension}"
if [ $nline2 -gt 0 ];then
  echo $str > $outputfile1
  echo "#nL = $nL nW = $nW" >>$outputfile1
  sed -n "${nline1},${nline2}p" $filename >> $outputfile1
  sed -n "${nline3},\$p" $filename > $outputfile2
else
  echo $str > $outputfile1
  echo "#nL = $nL nW = $nW" >>$outputfile1
  sed -n "${nline1},\$p" $filename >> $outputfile1
fi
#
nlines=$(wc -l "$outputfile1" | awk '{print $1-2}')
echo "$nlines" > $outputfile3
sed '1,2d' "$outputfile1" | awk '{print $1,$2,$3}' >> $outputfile3
echo -e "\033[0;33mthe following files are generated:\033[0m"
if [ $nline2 -gt 0 ];then
  echo -e "\033[0;33m${outputfile1}\n${outputfile2}\n${outputfile3}\033[0m"
else
  echo -e "\033[0;33m${outputfile1}\n${outputfile3}\033[0m"
fi
